<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vidmt.of.plugin.sub.tel.old.dao.LocationDao">
	<sql id="base_column_list">uid,lat,lon,`time`</sql>
	<select id="findByUid" resultType="Location">
		SELECT <include refid="base_column_list" /> FROM v_location WHERE uid = #{0}
	</select>
	<select id="findListByUids" resultType="Location">
		SELECT <include refid="base_column_list" /> FROM v_location WHERE uid IN
		<foreach item="item" index="index" collection="list" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</select>
	
	
	<sql id="distance_expression">
		6378.138*1000*2*asin(sqrt(pow(sin(
		(#{selfLat}-lat)*pi()/180/2),2)+cos(#{selfLat}*pi()/180)*cos(lat*pi()/180)*
		pow(sin((#{selfLon}-lon)*pi()/180/2),2)))
	</sql>
	<select id="getNearBy" resultType="Location">
		SELECT uid,lon,lat,`time`,
		<include refid="distance_expression" />
		AS distance
		FROM v_location_nearby AS a
		WHERE
		a.loc_private=0
		AND a.uid != #{selfUid}
		<if test="sex!=null">
			AND a.sex=#{sex}
		</if>
		<if test="birthStart!=null">
			AND a.birth >= #{birthStart}
		</if>
		<if test="birthEnd!=null">
			AND a.birth &lt;= #{birthEnd}
		</if>
		<if test="time!=null">
			AND `time`  > #{time}
		</if>
		<if test="distance!=null">
			having distance &lt; #{distance}
		</if>
		ORDER BY distance ASC
		<if test="offset!=null and limit!=null">
			limit #{offset},#{limit}
		</if>

	</select>
</mapper>